name: AI.Flow Auto Rollback

on:
  workflow_run:
    workflows: ["AI.Flow Pipeline"]
    types: [completed]
    branches: [main]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  check-and-rollback:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'failure'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 5

      - name: Check if rollback needed
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require('child_process');

            // Get the last merge commit
            let lastMerge;
            try {
              lastMerge = execSync('git log --merges -1 --format="%H %s"', {
                encoding: 'utf8'
              }).trim();
            } catch (e) {
              core.info('No merge commits found');
              return;
            }

            if (!lastMerge) return;

            const [hash, ...messageParts] = lastMerge.split(' ');
            const message = messageParts.join(' ');

            // Only rollback AI-generated merges
            if (!message.includes('AI.Flow') && !message.includes('ai/')) {
              core.info('Last merge is not AI-generated, skipping rollback');
              return;
            }

            core.info(`Considering rollback of commit ${hash}: ${message}`);

            // Create a revert PR instead of force-pushing
            try {
              execSync(`git revert --no-commit ${hash}`, { encoding: 'utf8' });

              const branch = `ai/revert/${hash.substring(0, 8)}`;
              execSync(`git checkout -b ${branch}`, { encoding: 'utf8' });
              execSync(`git commit -m "revert: rollback AI merge ${hash.substring(0, 8)}"`, {
                encoding: 'utf8'
              });
              execSync(`git push origin ${branch}`, { encoding: 'utf8' });

              // Create PR
              const { data: pr } = await github.rest.pulls.create({
                ...context.repo,
                title: `ðŸ”„ Rollback: ${message}`,
                body: [
                  '## Auto-Rollback',
                  '',
                  `CI failure detected after merge of: \`${hash.substring(0, 8)}\``,
                  `Original commit: ${message}`,
                  '',
                  '**This rollback was automatically triggered by AI.Flow Monitor.**',
                  '',
                  '---',
                  'ðŸ¤– Generated by AI.Flow'
                ].join('\n'),
                head: branch,
                base: 'main',
                labels: ['ai-generated', 'priority/critical']
              });

              core.info(`Rollback PR created: #${pr.number}`);
            } catch (e) {
              core.error(`Rollback failed: ${e.message}`);
            }
