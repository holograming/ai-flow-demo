name: AI.Flow Monitor

on:
  workflow_run:
    workflows: ["AI.Flow Pipeline"]
    types: [completed]

permissions:
  contents: read
  issues: write
  pull-requests: read

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Check pipeline result
        uses: actions/github-script@v7
        with:
          script: |
            const run = context.payload.workflow_run;

            if (run.conclusion === 'failure') {
              // Find the related issue
              const commitMessage = run.head_commit?.message || '';
              const issueMatch = commitMessage.match(/#(\d+)/);

              if (issueMatch) {
                const issueNumber = parseInt(issueMatch[1]);

                // Check for repeated failures (circuit breaker)
                const { data: comments } = await github.rest.issues.listComments({
                  ...context.repo,
                  issue_number: issueNumber
                });

                const failureComments = comments.filter(c =>
                  c.body.includes('AI.Flow íŒŒì´í”„ë¼ì¸ ì‹¤íŒ¨')
                );

                if (failureComments.length >= 3) {
                  // Circuit breaker: OPEN
                  await github.rest.issues.addLabels({
                    ...context.repo,
                    issue_number: issueNumber,
                    labels: ['ai-failed', 'ai-needs-human']
                  });

                  await github.rest.issues.createComment({
                    ...context.repo,
                    issue_number: issueNumber,
                    body: [
                      '## âš ï¸ AI.Flow ì„œí‚· ë¸Œë ˆì´ì»¤ ë°œë™',
                      '',
                      `ì—°ì† ${failureComments.length + 1}íšŒ ì‹¤íŒ¨ë¡œ ìë™ ì²˜ë¦¬ë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤.`,
                      'ì‚¬ëŒì˜ ê°œì…ì´ í•„ìš”í•©ë‹ˆë‹¤.',
                      '',
                      `**ë§ˆì§€ë§‰ ì‹¤í–‰**: ${run.html_url}`,
                      '',
                      '---',
                      'ğŸ¤– Generated by AI.Flow Monitor'
                    ].join('\n')
                  });
                } else {
                  await github.rest.issues.createComment({
                    ...context.repo,
                    issue_number: issueNumber,
                    body: [
                      '## âŒ AI.Flow íŒŒì´í”„ë¼ì¸ ì‹¤íŒ¨',
                      '',
                      `**ì‹¤í–‰**: ${run.html_url}`,
                      `**ì‹œë„**: ${failureComments.length + 1}/3`,
                      '',
                      'ì¬ì‹œë„í•©ë‹ˆë‹¤...',
                      '',
                      '---',
                      'ğŸ¤– Generated by AI.Flow Monitor'
                    ].join('\n')
                  });
                }
              }
            }

            if (run.conclusion === 'success') {
              core.info('Pipeline completed successfully');
            }
