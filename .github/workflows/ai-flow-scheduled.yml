name: AI.Flow Scheduled Reports

on:
  schedule:
    - cron: '0 2 * * *'     # Daily at 02:00 UTC - daily scan
    - cron: '0 3 * * 1'     # Weekly Monday 03:00 UTC - weekly analysis
    - cron: '0 4 1 * *'     # Monthly 1st 04:00 UTC - monthly summary
  workflow_dispatch:
    inputs:
      report_type:
        description: 'Report type to generate'
        required: true
        default: 'daily'
        type: choice
        options:
          - daily
          - weekly
          - monthly

permissions:
  contents: read
  issues: write

jobs:
  daily-scan:
    if: github.event.schedule == '0 2 * * *' || github.event.inputs.report_type == 'daily'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm install -g pnpm && pnpm install --frozen-lockfile

      - name: Run lint check
        id: lint
        run: pnpm lint 2>&1 | tee lint-report.txt
        continue-on-error: true

      - name: Run type check
        id: typecheck
        run: pnpm typecheck 2>&1 | tee typecheck-report.txt
        continue-on-error: true

      - name: Run tests with coverage
        id: tests
        run: pnpm test:coverage 2>&1 | tee test-report.txt
        continue-on-error: true

      - name: Security audit
        id: audit
        run: pnpm audit 2>&1 | tee audit-report.txt
        continue-on-error: true

      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: daily-report-${{ github.run_id }}
          path: |
            lint-report.txt
            typecheck-report.txt
            test-report.txt
            audit-report.txt
          retention-days: 90

  weekly-analysis:
    if: github.event.schedule == '0 3 * * 1' || github.event.inputs.report_type == 'weekly'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for hotspot analysis

      - uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm install -g pnpm && pnpm install --frozen-lockfile

      - name: Generate health report
        uses: actions/github-script@v7
        with:
          script: |
            // Hotspot analysis: most changed files in last 30 days
            const { execSync } = require('child_process');

            let hotspots = '';
            try {
              hotspots = execSync(
                'git log --since="30 days ago" --name-only --pretty=format: | sort | uniq -c | sort -rn | head -20',
                { encoding: 'utf8' }
              );
            } catch (e) {
              hotspots = 'Unable to analyze git history';
            }

            // TODO counts
            let todos = '';
            try {
              todos = execSync(
                'grep -r "TODO\\|FIXME\\|HACK\\|XXX" --include="*.ts" -c src/ 2>/dev/null || echo "0"',
                { encoding: 'utf8' }
              );
            } catch (e) {
              todos = '0';
            }

            const report = [
              '## ðŸ“Š AI.Flow ì£¼ê°„ ì½”ë“œ ê±´ê°•ì„± ë³´ê³ ì„œ',
              '',
              `**ê¸°ê°„**: ì§€ë‚œ 7ì¼`,
              `**ìƒì„±**: ${new Date().toISOString()}`,
              '',
              '### Hotspot íŒŒì¼ (ìµœê·¼ 30ì¼ ë³€ê²½ ë¹ˆë„)',
              '```',
              hotspots || '(ë°ì´í„° ì—†ìŒ)',
              '```',
              '',
              '### TODO/FIXME í˜„í™©',
              '```',
              todos || '0',
              '```',
              '',
              '---',
              'ðŸ¤– Generated by AI.Flow Health Reporter'
            ].join('\n');

            // Create issue with report
            await github.rest.issues.create({
              ...context.repo,
              title: `ðŸ“Š ì£¼ê°„ ì½”ë“œ ê±´ê°•ì„± ë³´ê³ ì„œ - ${new Date().toISOString().split('T')[0]}`,
              body: report,
              labels: ['ai-improvement']
            });

  monthly-summary:
    if: github.event.schedule == '0 4 1 * *' || github.event.inputs.report_type == 'monthly'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate monthly summary
        uses: actions/github-script@v7
        with:
          script: |
            // Collect monthly stats
            const { data: issues } = await github.rest.issues.listForRepo({
              ...context.repo,
              state: 'all',
              since: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString(),
              per_page: 100
            });

            const aiIssues = issues.filter(i =>
              i.labels.some(l => ['ai-auto', 'ai-completed', 'ai-failed'].includes(l.name))
            );
            const completed = aiIssues.filter(i =>
              i.labels.some(l => l.name === 'ai-completed')
            );
            const failed = aiIssues.filter(i =>
              i.labels.some(l => l.name === 'ai-failed')
            );

            const report = [
              '## ðŸ“ˆ AI.Flow ì›”ê°„ ì¢…í•© ë³´ê³ ì„œ',
              '',
              `**ê¸°ê°„**: ì§€ë‚œ 30ì¼`,
              '',
              '### íŒŒì´í”„ë¼ì¸ í†µê³„',
              `| ì§€í‘œ | ê°’ |`,
              `|------|-----|`,
              `| AI ì²˜ë¦¬ ì´ìŠˆ | ${aiIssues.length}ê±´ |`,
              `| ì™„ë£Œ | ${completed.length}ê±´ |`,
              `| ì‹¤íŒ¨ | ${failed.length}ê±´ |`,
              `| ì„±ê³µë¥  | ${aiIssues.length > 0 ? ((completed.length / aiIssues.length) * 100).toFixed(1) : 0}% |`,
              '',
              '---',
              'ðŸ¤– Generated by AI.Flow'
            ].join('\n');

            await github.rest.issues.create({
              ...context.repo,
              title: `ðŸ“ˆ ì›”ê°„ ì¢…í•© ë³´ê³ ì„œ - ${new Date().toISOString().split('T')[0]}`,
              body: report,
              labels: ['ai-improvement']
            });
