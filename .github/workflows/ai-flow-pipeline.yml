name: AI.Flow Pipeline

on:
  issues:
    types: [opened, assigned, labeled]
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]

# One pipeline per issue
concurrency:
  group: ai-flow-issue-${{ github.event.issue.number || github.event.pull_request.number }}
  cancel-in-progress: false

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write

jobs:
  # â”€â”€ Gate: Should AI process this? â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  gate:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      trigger_type: ${{ steps.check.outputs.trigger_type }}
    steps:
      - name: Check trigger conditions
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const event = context.eventName;
            let shouldRun = false;
            let triggerType = 'unknown';

            if (event === 'issues') {
              const labels = context.payload.issue.labels.map(l => l.name);
              const assignees = context.payload.issue.assignees.map(a => a.login);

              // Trigger if ai-auto label or assigned to bot
              if (labels.includes('ai-auto')) {
                shouldRun = true;
                triggerType = 'label';
              }
              if (assignees.includes('claude-bot')) {
                shouldRun = true;
                triggerType = 'assign';
              }
            }

            if (event === 'issue_comment') {
              const body = context.payload.comment.body;
              // Trigger on @claude mention or /ai- slash commands
              if (body.includes('@claude') || body.match(/^\/ai-/)) {
                shouldRun = true;
                triggerType = 'mention';
              }
            }

            if (event === 'pull_request_review_comment' || event === 'pull_request_review') {
              const body = context.payload.comment?.body || context.payload.review?.body || '';
              if (body.includes('@claude')) {
                shouldRun = true;
                triggerType = 'pr-mention';
              }
            }

            // Skip if issue already has ai-working label
            if (event === 'issues' || event === 'issue_comment') {
              const issue = context.payload.issue;
              const labels = issue.labels.map(l => l.name);
              if (labels.includes('ai-working')) {
                shouldRun = false;
              }
            }

            core.setOutput('should_run', shouldRun.toString());
            core.setOutput('trigger_type', triggerType);

  # â”€â”€ Stage 1: Triage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  triage:
    needs: gate
    if: needs.gate.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    outputs:
      autonomy_level: ${{ steps.classify.outputs.autonomy_level }}
      issue_type: ${{ steps.classify.outputs.issue_type }}
      difficulty: ${{ steps.classify.outputs.difficulty }}
    steps:
      - uses: actions/checkout@v4

      - name: Add ai-working label
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.payload.issue?.number;
            if (issueNumber) {
              await github.rest.issues.addLabels({
                ...context.repo,
                issue_number: issueNumber,
                labels: ['ai-working']
              });
            }

      - name: Classify issue
        id: classify
        uses: actions/github-script@v7
        with:
          script: |
            // MVP: Simple heuristic-based classification
            // TODO: Replace with Claude Haiku classification
            const issue = context.payload.issue;
            const title = (issue?.title || '').toLowerCase();
            const body = (issue?.body || '').toLowerCase();

            let type = 'feature';
            let difficulty = 'medium';
            let level = 2;

            // Type detection
            if (title.includes('bug') || title.includes('fix') || title.includes('error')) {
              type = 'bug';
            } else if (title.includes('doc') || title.includes('readme')) {
              type = 'docs';
            } else if (title.includes('refactor')) {
              type = 'refactor';
            } else if (title.includes('typo') || title.includes('lint')) {
              type = 'chore';
            }

            // Difficulty estimation
            if (type === 'chore' || title.includes('typo')) {
              difficulty = 'trivial';
              level = 0;
            } else if (type === 'docs' || title.includes('simple')) {
              difficulty = 'simple';
              level = 1;
            } else if (title.includes('security') || body.includes('security')) {
              difficulty = 'complex';
              level = 3;
            }

            core.setOutput('issue_type', type);
            core.setOutput('difficulty', difficulty);
            core.setOutput('autonomy_level', level.toString());

      - name: Post triage comment
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.payload.issue?.number;
            if (!issueNumber) return;

            const type = '${{ steps.classify.outputs.issue_type }}';
            const difficulty = '${{ steps.classify.outputs.difficulty }}';
            const level = '${{ steps.classify.outputs.autonomy_level }}';
            const levelNames = ['ì™„ì „ ììœ¨', 'ê³ ììœ¨', 'ë°˜ììœ¨', 'ë³´ì¡°í˜•'];

            const body = [
              '## ğŸ¤– AI.Flow ì´ìŠˆ ë¶„ë¥˜ ê²°ê³¼',
              '',
              '| í•­ëª© | ê²°ê³¼ |',
              '|------|------|',
              `| ìœ í˜• | \`${type}\` |`,
              `| ë‚œì´ë„ | \`${difficulty}\` |`,
              `| ììœ¨ ìˆ˜ì¤€ | Level ${level} (${levelNames[level]}) |`,
              '',
              'ì‘ì—…ì„ ì‹œì‘í•©ë‹ˆë‹¤...',
              '',
              '---',
              'ğŸ¤– Generated by AI.Flow'
            ].join('\n');

            await github.rest.issues.createComment({
              ...context.repo,
              issue_number: issueNumber,
              body
            });

  # â”€â”€ Stage 2-5: Code Generation (Claude Code Action) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  implement:
    needs: triage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm install -g pnpm && pnpm install --frozen-lockfile

      - name: Run Claude Code
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          max_turns: 15
          allowed_tools: "Edit,Read,Write,Bash(pnpm test),Bash(pnpm lint),Bash(pnpm typecheck)"
          direct_prompt: |
            Read PLAN.md and PROGRESS.md first.
            Implement the solution for issue #${{ github.event.issue.number }}.
            Follow the coding guidelines in CLAUDE.md.

      - name: Run lint
        run: pnpm lint
        continue-on-error: true

      - name: Run type check
        run: pnpm typecheck
        continue-on-error: true

      - name: Run tests
        run: pnpm test
        continue-on-error: true

  # â”€â”€ Stage 6: PR Creation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  create-pr:
    needs: [triage, implement]
    runs-on: ubuntu-latest
    if: success()
    steps:
      - uses: actions/checkout@v4

      - name: Update issue labels
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.payload.issue?.number;
            if (!issueNumber) return;

            // Remove ai-working, add ai-review-needed
            try {
              await github.rest.issues.removeLabel({
                ...context.repo,
                issue_number: issueNumber,
                name: 'ai-working'
              });
            } catch (e) { /* label might not exist */ }

            await github.rest.issues.addLabels({
              ...context.repo,
              issue_number: issueNumber,
              labels: ['ai-review-needed']
            });

      - name: Post completion comment
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.payload.issue?.number;
            if (!issueNumber) return;

            await github.rest.issues.createComment({
              ...context.repo,
              issue_number: issueNumber,
              body: [
                '## âœ… AI.Flow ì‘ì—… ì™„ë£Œ',
                '',
                'PRì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ë¦¬ë·°ë¥¼ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤.',
                '',
                '---',
                'ğŸ¤– Generated by AI.Flow'
              ].join('\n')
            });
